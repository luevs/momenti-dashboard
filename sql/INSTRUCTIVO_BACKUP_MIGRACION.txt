# INSTRUCTIVO: BACKUP DE SUPABASE Y MIGRACIÃ“N DE IDs

## ðŸ“‹ PASO 1: HACER BACKUP COMPLETO

### OpciÃ³n A: Backup desde Supabase Dashboard (RECOMENDADO)
1. Ve a tu proyecto de Supabase (https://supabase.com/dashboard)
2. Ve a **Database** â†’ **Backups**
3. Haz clic en **Create backup now**
4. Espera a que termine (aparecerÃ¡ en la lista)
5. **Descarga el backup** haciendo clic en el Ã­cono de descarga

### OpciÃ³n B: Backup con PostgreSQL (si tienes acceso directo)
```bash
# Abrir PowerShell como administrador
# Reemplaza los valores con tu informaciÃ³n de Supabase

# Obtener string de conexiÃ³n de Supabase:
# Ve a Settings â†’ Database â†’ Connection string â†’ Postgres

pg_dump "postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres" > backup_momenti_$(Get-Date -Format "yyyyMMdd_HHmmss").sql

# Ejemplo:
pg_dump "postgresql://postgres:tu_password@db.xyz.supabase.co:5432/postgres" > backup_momenti_20251115_143000.sql
```

### OpciÃ³n C: Backup de tablas especÃ­ficas (MÃS RÃPIDO)
```bash
# Solo las tablas crÃ­ticas para la migraciÃ³n
pg_dump "postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres" -t customers_ -t loyalty_programs -t order_history > backup_migration_tables.sql
```

## ðŸ“‹ PASO 2: VERIFICAR DATOS ANTES DE MIGRAR

### En Supabase SQL Editor, ejecuta:
```sql
-- Ver cuÃ¡ntos clientes tienes
SELECT COUNT(*) as total_customers FROM customers_;

-- Ver clientes con IDs largos
SELECT id, LENGTH(id::text) as id_length, razon_social 
FROM customers_ 
WHERE LENGTH(id::text) > 3 
ORDER BY id_length DESC 
LIMIT 10;

-- Ver relaciones que se van a actualizar
SELECT 
    (SELECT COUNT(*) FROM customers_) as customers_total,
    (SELECT COUNT(*) FROM loyalty_programs) as loyalty_programs_total,
    (SELECT COUNT(*) FROM order_history) as order_history_total;
```

## ðŸ“‹ PASO 3: EJECUTAR MIGRACIÃ“N (PASO A PASO)

### 3.1 Primero, ejecuta solo la funciÃ³n
```sql
-- Solo crear la funciÃ³n (sin migrar aÃºn)
CREATE OR REPLACE FUNCTION generate_3digit_id() 
RETURNS INTEGER AS $$
DECLARE
    new_id INTEGER;
    max_attempts INTEGER := 1000;
    attempts INTEGER := 0;
BEGIN
    LOOP
        new_id := floor(random() * 900 + 100)::INTEGER;
        IF NOT EXISTS (SELECT 1 FROM customers_ WHERE id::INTEGER = new_id) THEN
            RETURN new_id;
        END IF;
        attempts := attempts + 1;
        IF attempts >= max_attempts THEN
            RAISE EXCEPTION 'No se pudo generar un ID Ãºnico despuÃ©s de % intentos', max_attempts;
        END IF;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### 3.2 Crear tabla de mapeo
```sql
CREATE TABLE IF NOT EXISTS id_migration_map (
    old_id VARCHAR,
    new_id INTEGER,
    customer_name VARCHAR,
    migrated_at TIMESTAMP DEFAULT NOW()
);
```

### 3.3 PROBAR con UN SOLO cliente primero
```sql
-- Migrar SOLO UN cliente para probar
DO $$
DECLARE
    customer_record RECORD;
    new_customer_id INTEGER;
BEGIN
    -- Tomar solo el primer cliente con ID largo
    SELECT id, razon_social, alias 
    INTO customer_record
    FROM customers_ 
    WHERE LENGTH(id::text) > 3
    ORDER BY razon_social
    LIMIT 1;
    
    IF customer_record.id IS NOT NULL THEN
        -- Generar nuevo ID
        new_customer_id := generate_3digit_id();
        
        -- Guardar mapeo
        INSERT INTO id_migration_map (old_id, new_id, customer_name)
        VALUES (customer_record.id, new_customer_id, 
                COALESCE(customer_record.razon_social, customer_record.alias));
        
        -- Actualizar tablas (EN ORDEN)
        UPDATE order_history 
        SET customer_id = new_customer_id::text
        WHERE customer_id = customer_record.id;
        
        UPDATE loyalty_programs 
        SET customer_id = new_customer_id::text
        WHERE customer_id = customer_record.id;
        
        UPDATE customers_ 
        SET id = new_customer_id::text
        WHERE id = customer_record.id;
        
        RAISE NOTICE 'MIGRADO: % (ID: % -> %)', 
                     COALESCE(customer_record.razon_social, customer_record.alias),
                     customer_record.id, 
                     new_customer_id;
    END IF;
END $$;
```

### 3.4 Verificar que funcionÃ³
```sql
-- Ver el resultado de la prueba
SELECT * FROM id_migration_map;

-- Verificar que las relaciones funcionan
SELECT 
    c.id as customer_id,
    c.razon_social,
    COUNT(lp.id) as programas,
    COUNT(oh.id) as ordenes
FROM customers_ c
LEFT JOIN loyalty_programs lp ON c.id = lp.customer_id
LEFT JOIN order_history oh ON c.id = oh.customer_id
WHERE c.id IN (SELECT new_id::text FROM id_migration_map)
GROUP BY c.id, c.razon_social;
```

### 3.5 Si la prueba funcionÃ³, migrar TODOS
```sql
-- EJECUTAR EL SCRIPT COMPLETO (solo si la prueba fue exitosa)
-- Copia y pega todo el bloque DO $$ del archivo migrar_ids_3_digitos.sql
```

## ðŸ“‹ PASO 4: VERIFICAR MIGRACIÃ“N COMPLETA

```sql
-- Verificar que todos los IDs son de 3 dÃ­gitos
SELECT 
    COUNT(*) as total_customers,
    COUNT(CASE WHEN LENGTH(id) = 3 THEN 1 END) as ids_3_digitos,
    COUNT(CASE WHEN LENGTH(id) > 3 THEN 1 END) as ids_largos
FROM customers_;

-- Ver mapeo completo
SELECT COUNT(*) as clientes_migrados FROM id_migration_map;

-- Verificar integridad de datos
SELECT 
    'customers_' as tabla,
    COUNT(*) as registros
FROM customers_
WHERE LENGTH(id) <= 3
UNION ALL
SELECT 
    'loyalty_programs con relaciÃ³n vÃ¡lida' as tabla,
    COUNT(*) as registros
FROM loyalty_programs lp
JOIN customers_ c ON lp.customer_id = c.id;
```

## ðŸ“‹ PASO 5: ACTUALIZAR CONTRASEÃ‘AS

```sql
-- Ejecutar el script de contraseÃ±as
-- (usar el archivo cliente_passwords.sql)
ALTER TABLE customers_ ADD COLUMN IF NOT EXISTS client_password VARCHAR(50);

UPDATE customers_ 
SET client_password = substr(md5(random()::text), 1, 8)
WHERE client_password IS NULL OR client_password = '';
```

## ðŸ“‹ PASO 6: OBTENER LISTA FINAL

```sql
-- Ejecutar clientes_credenciales.sql para obtener la lista completa
-- de clientes con sus nuevos IDs y contraseÃ±as
```

## âš ï¸ IMPORTANTE:

1. **HACER BACKUP ANTES de cualquier cambio**
2. **PROBAR con 1 cliente** antes de migrar todos
3. **NO cerrar la ventana** de Supabase durante la migraciÃ³n
4. **Verificar cada paso** antes de continuar
5. **Tener el backup listo** para restaurar si algo sale mal

## ðŸ†˜ EN CASO DE ERROR:

### Si algo sale mal, restaurar backup:
```bash
# Desde PowerShell (usando tu backup)
psql "postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres" < backup_momenti_20251115_143000.sql
```

### O desde Supabase Dashboard:
1. Ve a **Database** â†’ **Backups**
2. Busca tu backup
3. Haz clic en **Restore**

---

## ðŸ“ž CONTACTO:
Si algo no funciona, comparte:
1. El mensaje de error exacto
2. En quÃ© paso ocurriÃ³
3. CuÃ¡ntos registros se procesaron antes del error